import demistomock as demisto  # noqa: F401
from CommonServerPython import *  # noqa: F401

scanID = '1210'
vulns = demisto.args()['vulns']

vuln_summary = {}
hosts = {}

for vuln in vulns:
    tmp = {}
    tmp['tenID'] = vuln['ID']

    if 'Solution' in vuln:
        tmp['tenSol'] = vuln['Solution']
    if 'Description' in vuln:
        tmp['tenDesc'] = vuln['Description']
    if 'Synopsis' in vuln:
        tmp['tenSyn'] = vuln['Synopsis']
    if 'CVE' in vuln:
        tmp['tenCVE'] = vuln['CVE']
        tmp['tenDesc'] + '\n\r' + str(vuln['CVE'])
    if 'Severity' in vuln:
        tmp['Sev'] = vuln['Severity']

    vuln_summary[vuln['ID']] = tmp

    for host in vuln['Host']:
        IP = host['IP']
        # hosts.append(IP)
        if IP in hosts:
            if vuln['ID'] in hosts[IP]['tenIDs']:
                continue
            else:
                hosts[IP]['tenIDs'].append(vuln['ID'])
                if 'CVE' in vuln:
                    hosts[IP]['cves'].extend(vuln['CVE'])
        else:
            if 'CVE' in vuln:
                cves = vuln['CVE']
            else:
                cves = []
            hosts[IP] = {'tenIDs': [vuln['ID']], 'MAC': host['MAC'], 'IP': IP, 'cves': cves}


# demisto.results(str(hosts))
# demisto.results(str(vuln_summary))

entry = {
    'Contents': hosts,
    'ContentsFormat': 'json',
    'EntryContext': {'TenableSummary': {'HOST': hosts, 'VULN': vuln_summary}}
}
demisto.results(entry)
