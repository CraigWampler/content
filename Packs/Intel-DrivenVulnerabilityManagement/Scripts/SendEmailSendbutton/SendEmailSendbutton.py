import time

import demistomock as demisto  # noqa: F401
from CommonServerPython import *  # noqa: F401

if demisto.args()['new'] == 'Send':

    tag = demisto.executeCommand("addEntitlement", {"persistent": True, "replyEntriesTag": "#"})[0]['Contents']

    demisto.executeCommand("setIncident", {"addEntitlementTag": tag})

    subject = demisto.incidents()[0]['CustomFields']['sendemailsubject'] + " - #" + demisto.investigation()['id'] + " " + tag
    to = demisto.incidents()[0]['CustomFields']['sendemailto']
    to = ','.join(to)
    body = demisto.incidents()[0]['CustomFields']['sendemailbody']

    demisto.executeCommand("send-mail", {"subject": subject, "to": to, "body": body})

    # This sleep doesn't appear to have an affect
    time.sleep(30)

    demisto.executeCommand("setIncident", {'sendemailbutton': '--'})
