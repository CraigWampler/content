import demistomock as demisto  # noqa: F401
from CommonServerPython import *  # noqa: F401

ind = demisto.args()['indicator']
indID = ind['id']
indTags = None
similarIncs = None

if 'CustomFields' in ind:
    indTags = ind['CustomFields']['tags'] if "tags" in ind['CustomFields'] else None
query = "indicator.value:"
if indTags:
    query += " or indicator.value:".join(indTags)
    similarIncs = demisto.executeCommand("getIncidents", {"query": f"{query}"})[0]["Contents"]["data"]

incs = demisto.executeCommand("getIncidents", {"query": f"indicator.id:{indID}"})[0]["Contents"]["data"]


score = 0
style = 'font-size: 10em; text-align: center;padding-top: 50px;'
if incs:
    for inc in incs:
        sev = inc["severity"]
        if sev == 1:
            score += 2
        elif sev == 2:
            score += 5
        elif sev == 3:
            score += 9
        else:
            score += 1

score = score * 2

if similarIncs:
    for inc in similarIncs:
        sev = inc["severity"]
        if sev == 1:
            score += 2
        elif sev == 2:
            score += 5
        elif sev == 3:
            score += 9
        else:
            score += 1


if score >= 80:
    style += 'color: red;'
elif 40 < score < 80:
    style += 'color: yellow;'

# text = '# Test'

text = f"<div style='{style}'><br><br><br>{score}</div>"
entry = {
    'Type': entryTypes["note"],
    'Contents': text,
    'ContentsFormat': formats['html'],
    'HumanReadable': text,
    'ReadableContentsFormat': formats['html']
}


demisto.results(entry)
