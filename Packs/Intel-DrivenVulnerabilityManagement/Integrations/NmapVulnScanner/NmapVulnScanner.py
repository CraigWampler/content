import json

import demistomock as demisto  # noqa: F401
from CommonServerPython import *  # noqa: F401
from libnmap.parser import NmapParser
from libnmap.process import NmapProcess
from libnmap.reportjson import ReportEncoder

if demisto.command() == 'test-module':
    demisto.results('ok')
    sys.exit(0)
if demisto.command() == 'nmap-scan':
    options = demisto.args()['options']
    nm = NmapProcess(argToList(demisto.args()['targets']), options=options, safe_mode=False)
    rc = nm.run()
    if rc != 0:
        demisto.results({
            'Type': entryTypes['error'],
            'ContentsFormat': formats['text'],
            'Contents': 'Unable to execute - ' + nm.stderr
        })
        sys.exit(0)
    raw = nm.stdout
    j = json.loads(xml2json(str(nm.stdout)).replace("@", ""))

    results = CommandResults(
        outputs_prefix='NMAPScan',
        outputs=j["nmaprun"]
    )
    return_results(results)
